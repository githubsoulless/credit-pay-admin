<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="net.chrone.creditpay.mapper.CouponMapper">
  <resultMap id="BaseResultMap" type="net.chrone.creditpay.model.Coupon">
    <!--
      WARNING - @mbggenerated
      This element is automatically generated by MyBatis Generator, do not modify.
      This element was generated on Thu Nov 30 15:11:11 CST 2017.
    -->
    <id column="id" jdbcType="VARCHAR" property="id" />
    <result column="name" jdbcType="VARCHAR" property="name" />
    <result column="amount" jdbcType="INTEGER" property="amount" />
    <result column="limit_amount_type" jdbcType="INTEGER" property="limitAmountType" />
    <result column="limit_amount" jdbcType="INTEGER" property="limitAmount" />
    <result column="coupan_count" jdbcType="INTEGER" property="coupanCount" />
    <result column="lottery_type" jdbcType="INTEGER" property="lotteryType" />
    <result column="probability_winning" jdbcType="DOUBLE" property="probabilityWinning" />
    <result column="validity_type" jdbcType="INTEGER" property="validityType" />
    <result column="fixed_days" jdbcType="INTEGER" property="fixedDays" />
    <result column="effect_start_time" jdbcType="TIMESTAMP" property="effectStartTime" />
    <result column="effect_end_time" jdbcType="TIMESTAMP" property="effectEndTime" />
    <result column="status" jdbcType="INTEGER" property="status" />
    <result column="coupon_desc" jdbcType="VARCHAR" property="couponDesc" />
    <result column="row_crt_usr" jdbcType="VARCHAR" property="rowCrtUsr" />
    <result column="row_crt_ts" jdbcType="TIMESTAMP" property="rowCrtTs" />
    <result column="rec_upd_usr" jdbcType="VARCHAR" property="recUpdUsr" />
    <result column="rec_upd_ts" jdbcType="TIMESTAMP" property="recUpdTs" />
  </resultMap>
  <sql id="Example_Where_Clause">
    <!--
      WARNING - @mbggenerated
      This element is automatically generated by MyBatis Generator, do not modify.
      This element was generated on Thu Nov 30 15:11:11 CST 2017.
    -->
    <where>
      <foreach collection="oredCriteria" item="criteria" separator="or">
        <if test="criteria.valid">
          <trim prefix="(" prefixOverrides="and" suffix=")">
            <foreach collection="criteria.criteria" item="criterion">
              <choose>
                <when test="criterion.noValue">
                  and ${criterion.condition}
                </when>
                <when test="criterion.singleValue">
                  and ${criterion.condition} #{criterion.value}
                </when>
                <when test="criterion.betweenValue">
                  and ${criterion.condition} #{criterion.value} and #{criterion.secondValue}
                </when>
                <when test="criterion.listValue">
                  and ${criterion.condition}
                  <foreach close=")" collection="criterion.value" item="listItem" open="(" separator=",">
                    #{listItem}
                  </foreach>
                </when>
              </choose>
            </foreach>
          </trim>
        </if>
      </foreach>
    </where>
  </sql>
  <sql id="Update_By_Example_Where_Clause">
    <!--
      WARNING - @mbggenerated
      This element is automatically generated by MyBatis Generator, do not modify.
      This element was generated on Thu Nov 30 15:11:11 CST 2017.
    -->
    <where>
      <foreach collection="example.oredCriteria" item="criteria" separator="or">
        <if test="criteria.valid">
          <trim prefix="(" prefixOverrides="and" suffix=")">
            <foreach collection="criteria.criteria" item="criterion">
              <choose>
                <when test="criterion.noValue">
                  and ${criterion.condition}
                </when>
                <when test="criterion.singleValue">
                  and ${criterion.condition} #{criterion.value}
                </when>
                <when test="criterion.betweenValue">
                  and ${criterion.condition} #{criterion.value} and #{criterion.secondValue}
                </when>
                <when test="criterion.listValue">
                  and ${criterion.condition}
                  <foreach close=")" collection="criterion.value" item="listItem" open="(" separator=",">
                    #{listItem}
                  </foreach>
                </when>
              </choose>
            </foreach>
          </trim>
        </if>
      </foreach>
    </where>
  </sql>
  <sql id="Base_Column_List">
    <!--
      WARNING - @mbggenerated
      This element is automatically generated by MyBatis Generator, do not modify.
      This element was generated on Thu Nov 30 15:11:11 CST 2017.
    -->
    id, name, amount, limit_amount_type, limit_amount, coupan_count, lottery_type, probability_winning, 
    validity_type, fixed_days, effect_start_time, effect_end_time, status, coupon_desc, 
    row_crt_usr, row_crt_ts, rec_upd_usr, rec_upd_ts
  </sql>
  <select id="selectByExample" parameterType="net.chrone.creditpay.model.CouponExample" resultMap="BaseResultMap">
    <!--
      WARNING - @mbggenerated
      This element is automatically generated by MyBatis Generator, do not modify.
      This element was generated on Thu Nov 30 15:11:11 CST 2017.
    -->
    select
    <if test="distinct">
      distinct
    </if>
    <include refid="Base_Column_List" />
    from t_coupon
    <if test="_parameter != null">
      <include refid="Example_Where_Clause" />
    </if>
    <if test="orderByClause != null">
      order by ${orderByClause}
    </if>
  </select>
  <select id="selectByPrimaryKey" parameterType="java.lang.String" resultMap="BaseResultMap">
    <!--
      WARNING - @mbggenerated
      This element is automatically generated by MyBatis Generator, do not modify.
      This element was generated on Thu Nov 30 15:11:11 CST 2017.
    -->
    select 
    <include refid="Base_Column_List" />
    from t_coupon
    where id = #{id,jdbcType=VARCHAR}
  </select>
  <delete id="deleteByPrimaryKey" parameterType="java.lang.String">
    <!--
      WARNING - @mbggenerated
      This element is automatically generated by MyBatis Generator, do not modify.
      This element was generated on Thu Nov 30 15:11:11 CST 2017.
    -->
    delete from t_coupon
    where id = #{id,jdbcType=VARCHAR}
  </delete>
  <delete id="deleteByExample" parameterType="net.chrone.creditpay.model.CouponExample">
    <!--
      WARNING - @mbggenerated
      This element is automatically generated by MyBatis Generator, do not modify.
      This element was generated on Thu Nov 30 15:11:11 CST 2017.
    -->
    delete from t_coupon
    <if test="_parameter != null">
      <include refid="Example_Where_Clause" />
    </if>
  </delete>
  <insert id="insert" parameterType="net.chrone.creditpay.model.Coupon">
    <!--
      WARNING - @mbggenerated
      This element is automatically generated by MyBatis Generator, do not modify.
      This element was generated on Thu Nov 30 15:11:11 CST 2017.
    -->
    insert into t_coupon (id, name, amount, 
      limit_amount_type, limit_amount, coupan_count, 
      lottery_type, probability_winning, validity_type, 
      fixed_days, effect_start_time, effect_end_time, 
      status, coupon_desc, row_crt_usr, 
      row_crt_ts, rec_upd_usr, rec_upd_ts
      )
    values (#{id,jdbcType=VARCHAR}, #{name,jdbcType=VARCHAR}, #{amount,jdbcType=INTEGER}, 
      #{limitAmountType,jdbcType=INTEGER}, #{limitAmount,jdbcType=INTEGER}, #{coupanCount,jdbcType=INTEGER}, 
      #{lotteryType,jdbcType=INTEGER}, #{probabilityWinning,jdbcType=DOUBLE}, #{validityType,jdbcType=INTEGER}, 
      #{fixedDays,jdbcType=INTEGER}, #{effectStartTime,jdbcType=TIMESTAMP}, #{effectEndTime,jdbcType=TIMESTAMP}, 
      #{status,jdbcType=INTEGER}, #{couponDesc,jdbcType=VARCHAR}, #{rowCrtUsr,jdbcType=VARCHAR}, 
      #{rowCrtTs,jdbcType=TIMESTAMP}, #{recUpdUsr,jdbcType=VARCHAR}, #{recUpdTs,jdbcType=TIMESTAMP}
      )
  </insert>
  <insert id="insertSelective" parameterType="net.chrone.creditpay.model.Coupon">
    <!--
      WARNING - @mbggenerated
      This element is automatically generated by MyBatis Generator, do not modify.
      This element was generated on Thu Nov 30 15:11:11 CST 2017.
    -->
    insert into t_coupon
    <trim prefix="(" suffix=")" suffixOverrides=",">
      <if test="id != null">
        id,
      </if>
      <if test="name != null">
        name,
      </if>
      <if test="amount != null">
        amount,
      </if>
      <if test="limitAmountType != null">
        limit_amount_type,
      </if>
      <if test="limitAmount != null">
        limit_amount,
      </if>
      <if test="coupanCount != null">
        coupan_count,
      </if>
      <if test="lotteryType != null">
        lottery_type,
      </if>
      <if test="probabilityWinning != null">
        probability_winning,
      </if>
      <if test="validityType != null">
        validity_type,
      </if>
      <if test="fixedDays != null">
        fixed_days,
      </if>
      <if test="effectStartTime != null">
        effect_start_time,
      </if>
      <if test="effectEndTime != null">
        effect_end_time,
      </if>
      <if test="status != null">
        status,
      </if>
      <if test="couponDesc != null">
        coupon_desc,
      </if>
      <if test="rowCrtUsr != null">
        row_crt_usr,
      </if>
      <if test="rowCrtTs != null">
        row_crt_ts,
      </if>
      <if test="recUpdUsr != null">
        rec_upd_usr,
      </if>
      <if test="recUpdTs != null">
        rec_upd_ts,
      </if>
    </trim>
    <trim prefix="values (" suffix=")" suffixOverrides=",">
      <if test="id != null">
        #{id,jdbcType=VARCHAR},
      </if>
      <if test="name != null">
        #{name,jdbcType=VARCHAR},
      </if>
      <if test="amount != null">
        #{amount,jdbcType=INTEGER},
      </if>
      <if test="limitAmountType != null">
        #{limitAmountType,jdbcType=INTEGER},
      </if>
      <if test="limitAmount != null">
        #{limitAmount,jdbcType=INTEGER},
      </if>
      <if test="coupanCount != null">
        #{coupanCount,jdbcType=INTEGER},
      </if>
      <if test="lotteryType != null">
        #{lotteryType,jdbcType=INTEGER},
      </if>
      <if test="probabilityWinning != null">
        #{probabilityWinning,jdbcType=DOUBLE},
      </if>
      <if test="validityType != null">
        #{validityType,jdbcType=INTEGER},
      </if>
      <if test="fixedDays != null">
        #{fixedDays,jdbcType=INTEGER},
      </if>
      <if test="effectStartTime != null">
        #{effectStartTime,jdbcType=TIMESTAMP},
      </if>
      <if test="effectEndTime != null">
        #{effectEndTime,jdbcType=TIMESTAMP},
      </if>
      <if test="status != null">
        #{status,jdbcType=INTEGER},
      </if>
      <if test="couponDesc != null">
        #{couponDesc,jdbcType=VARCHAR},
      </if>
      <if test="rowCrtUsr != null">
        #{rowCrtUsr,jdbcType=VARCHAR},
      </if>
      <if test="rowCrtTs != null">
        #{rowCrtTs,jdbcType=TIMESTAMP},
      </if>
      <if test="recUpdUsr != null">
        #{recUpdUsr,jdbcType=VARCHAR},
      </if>
      <if test="recUpdTs != null">
        #{recUpdTs,jdbcType=TIMESTAMP},
      </if>
    </trim>
  </insert>
  <select id="countByExample" parameterType="net.chrone.creditpay.model.CouponExample" resultType="java.lang.Integer">
    <!--
      WARNING - @mbggenerated
      This element is automatically generated by MyBatis Generator, do not modify.
      This element was generated on Thu Nov 30 15:11:11 CST 2017.
    -->
    select count(*) from t_coupon
    <if test="_parameter != null">
      <include refid="Example_Where_Clause" />
    </if>
  </select>
  <update id="updateByExampleSelective" parameterType="map">
    <!--
      WARNING - @mbggenerated
      This element is automatically generated by MyBatis Generator, do not modify.
      This element was generated on Thu Nov 30 15:11:11 CST 2017.
    -->
    update t_coupon
    <set>
      <if test="record.id != null">
        id = #{record.id,jdbcType=VARCHAR},
      </if>
      <if test="record.name != null">
        name = #{record.name,jdbcType=VARCHAR},
      </if>
      <if test="record.amount != null">
        amount = #{record.amount,jdbcType=INTEGER},
      </if>
      <if test="record.limitAmountType != null">
        limit_amount_type = #{record.limitAmountType,jdbcType=INTEGER},
      </if>
      <if test="record.limitAmount != null">
        limit_amount = #{record.limitAmount,jdbcType=INTEGER},
      </if>
      <if test="record.coupanCount != null">
        coupan_count = #{record.coupanCount,jdbcType=INTEGER},
      </if>
      <if test="record.lotteryType != null">
        lottery_type = #{record.lotteryType,jdbcType=INTEGER},
      </if>
      <if test="record.probabilityWinning != null">
        probability_winning = #{record.probabilityWinning,jdbcType=DOUBLE},
      </if>
      <if test="record.validityType != null">
        validity_type = #{record.validityType,jdbcType=INTEGER},
      </if>
      <if test="record.fixedDays != null">
        fixed_days = #{record.fixedDays,jdbcType=INTEGER},
      </if>
      <if test="record.effectStartTime != null">
        effect_start_time = #{record.effectStartTime,jdbcType=TIMESTAMP},
      </if>
      <if test="record.effectEndTime != null">
        effect_end_time = #{record.effectEndTime,jdbcType=TIMESTAMP},
      </if>
      <if test="record.status != null">
        status = #{record.status,jdbcType=INTEGER},
      </if>
      <if test="record.couponDesc != null">
        coupon_desc = #{record.couponDesc,jdbcType=VARCHAR},
      </if>
      <if test="record.rowCrtUsr != null">
        row_crt_usr = #{record.rowCrtUsr,jdbcType=VARCHAR},
      </if>
      <if test="record.rowCrtTs != null">
        row_crt_ts = #{record.rowCrtTs,jdbcType=TIMESTAMP},
      </if>
      <if test="record.recUpdUsr != null">
        rec_upd_usr = #{record.recUpdUsr,jdbcType=VARCHAR},
      </if>
      <if test="record.recUpdTs != null">
        rec_upd_ts = #{record.recUpdTs,jdbcType=TIMESTAMP},
      </if>
    </set>
    <if test="_parameter != null">
      <include refid="Update_By_Example_Where_Clause" />
    </if>
  </update>
  <update id="updateByExample" parameterType="map">
    <!--
      WARNING - @mbggenerated
      This element is automatically generated by MyBatis Generator, do not modify.
      This element was generated on Thu Nov 30 15:11:11 CST 2017.
    -->
    update t_coupon
    set id = #{record.id,jdbcType=VARCHAR},
      name = #{record.name,jdbcType=VARCHAR},
      amount = #{record.amount,jdbcType=INTEGER},
      limit_amount_type = #{record.limitAmountType,jdbcType=INTEGER},
      limit_amount = #{record.limitAmount,jdbcType=INTEGER},
      coupan_count = #{record.coupanCount,jdbcType=INTEGER},
      lottery_type = #{record.lotteryType,jdbcType=INTEGER},
      probability_winning = #{record.probabilityWinning,jdbcType=DOUBLE},
      validity_type = #{record.validityType,jdbcType=INTEGER},
      fixed_days = #{record.fixedDays,jdbcType=INTEGER},
      effect_start_time = #{record.effectStartTime,jdbcType=TIMESTAMP},
      effect_end_time = #{record.effectEndTime,jdbcType=TIMESTAMP},
      status = #{record.status,jdbcType=INTEGER},
      coupon_desc = #{record.couponDesc,jdbcType=VARCHAR},
      row_crt_usr = #{record.rowCrtUsr,jdbcType=VARCHAR},
      row_crt_ts = #{record.rowCrtTs,jdbcType=TIMESTAMP},
      rec_upd_usr = #{record.recUpdUsr,jdbcType=VARCHAR},
      rec_upd_ts = #{record.recUpdTs,jdbcType=TIMESTAMP}
    <if test="_parameter != null">
      <include refid="Update_By_Example_Where_Clause" />
    </if>
  </update>
  <update id="updateByPrimaryKeySelective" parameterType="net.chrone.creditpay.model.Coupon">
    <!--
      WARNING - @mbggenerated
      This element is automatically generated by MyBatis Generator, do not modify.
      This element was generated on Thu Nov 30 15:11:11 CST 2017.
    -->
    update t_coupon
    <set>
      <if test="name != null">
        name = #{name,jdbcType=VARCHAR},
      </if>
      <if test="amount != null">
        amount = #{amount,jdbcType=INTEGER},
      </if>
      <if test="limitAmountType != null">
        limit_amount_type = #{limitAmountType,jdbcType=INTEGER},
      </if>
      <if test="limitAmount != null">
        limit_amount = #{limitAmount,jdbcType=INTEGER},
      </if>
      <if test="coupanCount != null">
        coupan_count = #{coupanCount,jdbcType=INTEGER},
      </if>
      <if test="lotteryType != null">
        lottery_type = #{lotteryType,jdbcType=INTEGER},
      </if>
      <if test="probabilityWinning != null">
        probability_winning = #{probabilityWinning,jdbcType=DOUBLE},
      </if>
      <if test="validityType != null">
        validity_type = #{validityType,jdbcType=INTEGER},
      </if>
      <if test="fixedDays != null">
        fixed_days = #{fixedDays,jdbcType=INTEGER},
      </if>
      <if test="effectStartTime != null">
        effect_start_time = #{effectStartTime,jdbcType=TIMESTAMP},
      </if>
      <if test="effectEndTime != null">
        effect_end_time = #{effectEndTime,jdbcType=TIMESTAMP},
      </if>
      <if test="status != null">
        status = #{status,jdbcType=INTEGER},
      </if>
      <if test="couponDesc != null">
        coupon_desc = #{couponDesc,jdbcType=VARCHAR},
      </if>
      <if test="rowCrtUsr != null">
        row_crt_usr = #{rowCrtUsr,jdbcType=VARCHAR},
      </if>
      <if test="rowCrtTs != null">
        row_crt_ts = #{rowCrtTs,jdbcType=TIMESTAMP},
      </if>
      <if test="recUpdUsr != null">
        rec_upd_usr = #{recUpdUsr,jdbcType=VARCHAR},
      </if>
      <if test="recUpdTs != null">
        rec_upd_ts = #{recUpdTs,jdbcType=TIMESTAMP},
      </if>
    </set>
    where id = #{id,jdbcType=VARCHAR}
  </update>
  <update id="updateByPrimaryKey" parameterType="net.chrone.creditpay.model.Coupon">
    <!--
      WARNING - @mbggenerated
      This element is automatically generated by MyBatis Generator, do not modify.
      This element was generated on Thu Nov 30 15:11:11 CST 2017.
    -->
    update t_coupon
    set name = #{name,jdbcType=VARCHAR},
      amount = #{amount,jdbcType=INTEGER},
      limit_amount_type = #{limitAmountType,jdbcType=INTEGER},
      limit_amount = #{limitAmount,jdbcType=INTEGER},
      coupan_count = #{coupanCount,jdbcType=INTEGER},
      lottery_type = #{lotteryType,jdbcType=INTEGER},
      probability_winning = #{probabilityWinning,jdbcType=DOUBLE},
      validity_type = #{validityType,jdbcType=INTEGER},
      fixed_days = #{fixedDays,jdbcType=INTEGER},
      effect_start_time = #{effectStartTime,jdbcType=TIMESTAMP},
      effect_end_time = #{effectEndTime,jdbcType=TIMESTAMP},
      status = #{status,jdbcType=INTEGER},
      coupon_desc = #{couponDesc,jdbcType=VARCHAR},
      row_crt_usr = #{rowCrtUsr,jdbcType=VARCHAR},
      row_crt_ts = #{rowCrtTs,jdbcType=TIMESTAMP},
      rec_upd_usr = #{recUpdUsr,jdbcType=VARCHAR},
      rec_upd_ts = #{recUpdTs,jdbcType=TIMESTAMP}
    where id = #{id,jdbcType=VARCHAR}
  </update>
  
  <sql id="where_page">
  	<where>
  		<if test="name !=null and name !=''">
  			and t.name like concat(concat('%',#{name}),'%')
	  	</if>
	  	<if test="id !=null and id !=''">
  			and t.id = #{id}
	  	</if>
	  	<if test="status !=null">
  			and t.status = #{status}
	  	</if>
	  	<if test="lotteryType !=null">
  			and t.lottery_type = #{lotteryType}
	  	</if>
	  	<if test="levelId !=null">
	  		and b.level_id = #{levelId}
	  	</if>
  	</where>
  </sql>
  
  <select id="countCoupons" parameterType="net.chrone.creditpay.model.Coupon" resultType="int">
  	select count(1) from (
		select t.id from t_coupon t left join t_coupon_level b on t.id=b.id <include refid="where_page" /> group by t.id 
	)a
  </select>
  
  <resultMap extends="BaseResultMap" id="couponResult" type="net.chrone.creditpay.model.Coupon">
  	 <result column="totalCount" jdbcType="INTEGER" property="totalCount" />
  	  <result column="unUsedCount" jdbcType="INTEGER" property="unUsedCount" />
  	  <result column="overdueCount" jdbcType="INTEGER" property="overdueCount" />
  	  <result column="usedCount" jdbcType="INTEGER" property="usedCount" />
   <collection ofType="net.chrone.creditpay.model.Level" property="levels">
   	<id column="level_id" property="levelId" />
   	<result column="level_name" property="levelName" />
   </collection>
  </resultMap>
  
  <!-- select t.*,c.level_id,c.level_name,(select count(1) from t_coupon_detail d where d.coupon_id=t.id ) as totalCount, 
  		(select count(1) from t_coupon_detail e where e.coupon_id=t.id and status = 0 ) as unUsedCount
  		from (select t.* from t_coupon t left outer join t_coupon_level b on t.id=b.id <include refid="where_levelIds" /> group by t.id) t
  		left outer join t_coupon_level b on t.id=b.id
  		left outer join t_level_inf c on b.level_id = c.level_id  -->
  <select id="listcoupons" parameterType="net.chrone.creditpay.model.Coupon" resultMap="couponResult">
  	select a.* from (
  		select t.*,(select count(1) from t_coupon_detail d where d.coupon_id=t.id ) as totalCount, 
  		(select count(1) from t_coupon_detail e where e.coupon_id=t.id and status = 1 ) as usedCount,
  		(select count(1) from t_coupon_detail e where e.coupon_id=t.id and status = 2 ) as overdueCount
  		from t_coupon t
  		left outer join t_coupon_level b on t.id=b.id
  		<include refid="where_page" /> group by t.id order by t.row_crt_ts desc
  	)a limit #{startRow} , #{pageSize}
  </select>
  
  <select id="getCouponByPrimaayKey" parameterType="String" resultMap="couponResult">
  	select t.*,c.level_id,c.level_name from t_coupon t 
  	left outer join t_coupon_level b on t.id=b.id 
  	left outer join t_level_inf c on b.level_id = c.level_id 
  	where t.id=#{id}
  </select>
  
   <resultMap id="levelResult" type="net.chrone.creditpay.model.Level">
   	<id column="level_id" property="levelId" />
   	<result column="level_name" property="levelName" />
  </resultMap>
  
  <select id="listLevels" parameterType="String" resultMap="levelResult">
  	select b.level_id,b.level_name from t_coupon_level a left join t_level_inf b on a.level_id=b.level_id where a.id=#{id} order by b.level_id asc
  </select>
  	
</mapper>